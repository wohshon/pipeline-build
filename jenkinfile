node {
  //stage 'Git checkout'
  //echo 'Checking out repo'
  //git url: 'https://github.com/wohshon/cakephp-ex'

  stage 'Deploy in Development'
  echo ' Deploy apps in development'
  deployDev('myapp-dev')

  stage 'Automated tests'
  echo 'This stage simulates automated tests'
  sleep 30
  sh "curl -I http://cakephp-example-myapp-dev.cloudapps.demo.com"

  stage 'Deploy to QA'
  echo 'Deploying to QA'
  deployApp('myapp-dev', 'myapp-qa','qa')

  stage 'Wait for approval'
  input 'Aprove to production?'

  stage 'Deploy to production'
  echo 'Deploying to production'
  deployApp('myapp-dev', 'myapp', 'prod')
}

// Login and set the project
def projectSet(String project){
    sh "oc new-project ${project} || echo 'Project exists'"
    sh "oc project ${project}"
}
// Creates a deployment in dev, you should have already deploy manually so that the image is there
def deployDev(String project){
    projectSet(project)
    sh "oc policy add-role-to-user edit system:serviceaccount:ci-cd:default -n ${project}"
    sh "oc new-build --name=cakephp-example openshift/php:5.6~https://github.com/wohshon/cakephp-ex || echo 'Build Exist!'"
    sh "oc start-build nodejs-example --wait"
    sleep 30
    sh "oc new-app --image-stream=${project}/nodejs-example:latest || echo 'Application exist!'"
    sh "oc expose svc nodejs-example || echo 'route already exist'"
}

// Tag the ImageStream from an original project to force a deployment
def deployApp(String origProject, String project, String tagname){
    projectSet(project)
    sh "oc policy add-role-to-user edit system:serviceaccount:cd-cd:default -n ${project}"
    sh "oc policy add-role-to-group system:image-puller system:serviceaccounts:cic-cd -n ${origProject}"
    sh "oc policy add-role-to-group system:image-puller system:serviceaccounts:${project} -n ${origProject}"
    sh "oc tag ${origProject}/cakephp-example:latest ${project}/nodejs-example:${tagname}"
    sh "oc new-app --image-stream=${project}/cakephp-example:${tagname} || echo 'Application already exist'"
    sleep 10
    sh "oc expose svc cakephp-example || echo 'route already exist'"
}

